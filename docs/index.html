<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Detecting Count Anomalies Using Bayesian Hierarchical Models • countcheck</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Detecting Count Anomalies Using Bayesian Hierarchical Models">
<meta property="og:description" content="Dertermines upper control limits for count data.
  Reasonable results also in cases with few or no observed events.
  HTML reports.
    Model and code are based on examples in McElreath [2020] and
  Gelman et al. [2014].">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">countcheck</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="articles/countcheck.html">Get started</a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jmeydam/countcheck/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="countcheck" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#countcheck" class="anchor"></a>countcheck</h1></div>
<div id="detecting-count-anomalies-using-bayesian-hierarchical-models" class="section level2">
<h2 class="hasAnchor">
<a href="#detecting-count-anomalies-using-bayesian-hierarchical-models" class="anchor"></a>Detecting Count Anomalies Using Bayesian Hierarchical Models</h2>
<p>Prototype (R package).</p>
<ul>
<li>Dertermines upper control limits for count data</li>
<li>Reasonable results also in cases with few or no observed events</li>
<li>HTML reports</li>
</ul>
<p>Model and code are based on examples in <a href="https://xcelab.net/rm/statistical-rethinking/">McElreath (2020)</a> and <a href="https://www.stat.columbia.edu/~gelman/book/">Gelman et al. (2014)</a>.</p>
<p>This prototype is related to a previous <a href="https://jmeydam.github.io/count-anomalies/simulation_study.html">simulation study</a>.</p>
<p>The distributions and parameters in the simulation study were chosen so that the generated data is comparable to certain data of interest. The prototype is meant to be used for roughly the same kind of data. Please refer to the <a href="https://jmeydam.github.io/count-anomalies/simulation_study.html">report</a> for details.</p>
<p>The package documentation can be accessed via the <a href="https://jmeydam.github.io/countcheck/">package website</a>.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>First install dependencies:</p>
<ul>
<li>actuar</li>
<li>extraDistr</li>
<li>rstan (<a href="https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started">instructions</a>)</li>
<li>rethinking (&gt;= 2.01)</li>
</ul>
<p>The rethinking package needs to be installed from <a href="https://github.com/rmcelreath/rethinking">GitHub</a>.</p>
<p>The prototype can then be installed from GitHub with:</p>
<pre><code>&gt; devtools::install_github("https://github.com/jmeydam/countcheck.git", 
+                          build_vignettes = FALSE)</code></pre>
</div>
<div id="example-1" class="section level2">
<h2 class="hasAnchor">
<a href="#example-1" class="anchor"></a>Example 1</h2>
<p>Count data for 1000 observational units are simulated, assuming a “normal” data-generating process.</p>
<p>Since the data-generating process is free of anomalies, all counts exceeding their respective upper control limits (UCLs) are false positives. Other things being equal it is desirable to have as few false positives as possible.</p>
<p>Using a Bayesian hierarchical model with partial pooling, 18 new counts exceed their respective upper control limits, vs. 68 when using a no-pooling model. (4 counts exceed the UCLs based on the true value of the parameter <em>theta</em>, which is known in this case.)</p>
<pre><code>&gt; library(countcheck)

&gt; d &lt;- countcheck(random_seed = 200807)

&gt; # Counts exceeding UCLs
&gt; # *********************
&gt; # ucl_true_theta:
&gt; sum(d$y_new - d$ucl_true_theta &gt; 0)
[1] 4
&gt; # ucl_nopool:
&gt; sum(d$y_new - d$ucl_nopool &gt; 0)
[1] 68
&gt; # ucl_complpool:
&gt; sum(d$y_new - d$ucl_complpool &gt; 0)
[1] 74
&gt; # ucl_partpool:
&gt; sum(d$y_new - d$ucl_partpool &gt; 0)
[1] 18

## Example 2

The count data in the first example were simulated with a known, "normal"
data-generating process. Some new count values of interest _y_new_ were 0.

In this example we change _y_new_ as follows:

`y_new = round(2 * ceiling(e$n_new * e$true_theta))`

This is essentially twice the expected value for _y_new_, given a new 
reference count value n_new (used as a measure of exposure) and a value 
for _theta_. We round the result up, and the lowest possible value in 
this example is 1.

Since we use a factor of 2, it is likely that the product will often
exceed the upper control limit (UCL).

Using a Bayesian hierarchical model with partial pooling, 332 new counts exceed
their respective upper control limits, vs. 489 when using a no-pooling 
model. 310 counts exceed the UCLs based on the true value of the parameter 
_theta_, which is known in this case.
</code></pre>
<blockquote>
<p>d2 &lt;- countcheck(unit = e$unit,</p>
</blockquote>
<ul>
<li><div class="sourceCode" id="cb3"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a>             n =<span class="st"> </span>e<span class="op">$</span>n,</span></code></pre></div></li>
<li><div class="sourceCode" id="cb4"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a>             y =<span class="st"> </span>e<span class="op">$</span>y,</span></code></pre></div></li>
<li><div class="sourceCode" id="cb5"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a>             n_new =<span class="st"> </span>e<span class="op">$</span>n_new,</span></code></pre></div></li>
<li><div class="sourceCode" id="cb6"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a>             y_new =<span class="st"> </span><span class="kw">round</span>(<span class="dv">2</span> <span class="op">*</span><span class="st"> </span><span class="kw">ceiling</span>(e<span class="op">$</span>n_new <span class="op">*</span><span class="st"> </span>e<span class="op">$</span>true_theta)),</span></code></pre></div></li>
<li><div class="sourceCode" id="cb7"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a>             true_theta =<span class="st"> </span>e<span class="op">$</span>true_theta,</span></code></pre></div></li>
<li><div class="sourceCode" id="cb8"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1"></a>             random_seed =<span class="st"> </span><span class="dv">200807</span><span class="er">)</span></span></code></pre></div></li>
</ul>
<blockquote>
<h1 id="counts-exceeding-ucls">Counts exceeding UCLs</h1>
<h1 id="section">*********************</h1>
<h1 id="ucl_true_theta">ucl_true_theta:</h1>
<p>sum(d2<span class="math inline"><em>y</em><sub><em>n</em></sub><em>e</em><em>w</em> − <em>d</em>2</span>ucl_true_theta &gt; 0) [1] 310</p>
<h1 id="ucl_nopool">ucl_nopool:</h1>
<p>sum(d2<span class="math inline"><em>y</em><sub><em>n</em></sub><em>e</em><em>w</em> − <em>d</em>2</span>ucl_nopool &gt; 0) [1] 489</p>
<h1 id="ucl_complpool">ucl_complpool:</h1>
<p>sum(d2<span class="math inline"><em>y</em><sub><em>n</em></sub><em>e</em><em>w</em> − <em>d</em>2</span>ucl_complpool &gt; 0) [1] 343</p>
<h1 id="ucl_partpool">ucl_partpool:</h1>
<p>sum(d2<span class="math inline"><em>y</em><sub><em>n</em></sub><em>e</em><em>w</em> − <em>d</em>2</span>ucl_partpool &gt; 0) [1] 332</p>
</blockquote>
<pre><code>
As analyzed in detail in the
[simulation study](https://jmeydam.github.io/count-anomalies/simulation_study.html),
if we gradually increase the factor from 1 to 8 we will find that the number
of cases exceeding the UCL is similar for the partial-pooling and true-theta 
UCLs, but initially substantially higher for the no-pooling UCLs, as was 
demonstrated here for a factor of 2. The no-pooling UCL performs poorly 
especially when the previously observed count _y_ was 0, leading to an UCL
of 0.5.

The general results are not affected when changing the seed value.

In a realistic scenario it is not possible to assess performance by
comparison with "true" values. The true values of _theta_ are generally 
not known, and the probability distributions assumed for the Bayesian 
hierarchical model (the no-pooling model) may in fact be inappropriate.

On the other hand, in a realistic scenario it is often possible to assess 
performance by investigating individual cases.

## HTML Report

Select data from data frame d (example 1 above) for the report:
</code></pre>
<blockquote>
<p>countcheck_df &lt;- select_for_report(d)</p>
</blockquote>
<pre><code>
Result:
</code></pre>
<blockquote>
<p>str(countcheck_df) ‘data.frame’: 18 obs. of 3 variables: $ y_new : int 8 16 51 3 4 5 5 6 6 7 … $ ucl_partpool: num 5.5 11.5 42.5 2.5 3.5 4.5 4.5 5.5 5.5 6.5 … $ unit : int 462 698 935 109 228 399 598 374 613 751 …</p>
</blockquote>
<pre><code>
We also need a data frame with unit master data.
Here, we just simulate data:
</code></pre>
<blockquote>
<p>units_tmp &lt;- sort(unique(countcheck_df$unit)) unit_df &lt;- data.frame(</p>
</blockquote>
<ul>
<li>unit = units_tmp,</li>
<li>unit_name = paste(“Unit”,</li>
<li><div class="sourceCode" id="cb12"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1"></a>                units_tmp<span class="er">)</span>,</span></code></pre></div></li>
<li>unit_url = paste0(“<a href="http://domain/units/" class="uri">http://domain/units/</a>”,</li>
<li><div class="sourceCode" id="cb13"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1"></a>                units_tmp,</span></code></pre></div></li>
<li><div class="sourceCode" id="cb14"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1"></a>                <span class="st">".html"</span><span class="er">)</span>,</span></code></pre></div></li>
<li>unit_group_name = paste(“Group”,</li>
<li><div class="sourceCode" id="cb15"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1"></a>                      <span class="kw">rep</span>(<span class="dv">1</span><span class="op">:</span><span class="dv">5</span>,</span></code></pre></div></li>
<li><div class="sourceCode" id="cb16"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1"></a>                          length.out =<span class="st"> </span><span class="kw">length</span>(units_tmp)<span class="er">))</span></span></code></pre></div></li>
<li>)</li>
</ul>
<pre><code>
Result:
</code></pre>
<blockquote>
<p>str(unit_df) ‘data.frame’: 18 obs. of 4 variables: $ unit : int 109 228 364 374 399 462 501 529 598 613 … $ unit_name : chr “Unit 109” “Unit 228” “Unit 364” “Unit 374” … $ unit_url : chr “<a href="http://domain/units/109.html" class="uri">http://domain/units/109.html</a>” “<a href="http://domain/units/228.html" class="uri">http://domain/units/228.html</a>” “<a href="http://domain/units/364.html" class="uri">http://domain/units/364.html</a>” “<a href="http://domain/units/374.html" class="uri">http://domain/units/374.html</a>” … $ unit_group_name: chr “Group 1” “Group 2” “Group 3” “Group 4” …</p>
</blockquote>
<pre><code>
Generate report as R string:
</code></pre>
<blockquote>
<p>report &lt;- html_report(</p>
</blockquote>
<ul>
<li>countcheck_list = list(</li>
<li><div class="sourceCode" id="cb19"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1"></a><span class="kw">list</span>(<span class="dt">df =</span> countcheck_df, <span class="dt">caption =</span> <span class="st">"KPI 1"</span>)</span></code></pre></div></li>
<li>),</li>
<li>unit_df = unit_df,</li>
<li>title = “Report”,</li>
<li>table_width_px = 500,</li>
<li>column_headers = c(</li>
<li><div class="sourceCode" id="cb20"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1"></a>group =<span class="st"> "Group"</span>,</span></code></pre></div></li>
<li><div class="sourceCode" id="cb21"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1"></a>count =<span class="st"> "Count"</span>,</span></code></pre></div></li>
<li><div class="sourceCode" id="cb22"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1"></a>ucl =<span class="st"> "UCL"</span>,</span></code></pre></div></li>
<li><div class="sourceCode" id="cb23"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1"></a>unit =<span class="st"> "Unit"</span>,</span></code></pre></div></li>
<li><div class="sourceCode" id="cb24"><pre class="sourceCode R"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1"></a>name =<span class="st"> "Name"</span><span class="er">)</span>,</span></code></pre></div></li>
<li>charset = “utf-8”,</li>
<li>lang = “en”,</li>
<li>home_url = “<a href="https://github.com/jmeydam/countcheck" class="uri">https://github.com/jmeydam/countcheck</a>”)</li>
</ul>
<pre><code>
Save HTML report to disk:
</code></pre>
<blockquote>
<p>sink(“report.html”) cat(report) sink() ```</p>
</blockquote>
<p><a href="https://raw.githubusercontent.com/jmeydam/countcheck/master/report.html">View HTML code</a></p>
<p><a href="https://jmeydam.github.io/countcheck/report.html">View report</a></p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Browse source code at <br><a href="https://github.com/jmeydam/countcheck/">https://​github.com/​jmeydam/​countcheck/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/jmeydam/countcheck/issues">https://​github.com/​jmeydam/​countcheck/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="https://opensource.org/licenses/mit-license.php">MIT</a></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Jens Meydam <br><small class="roles"> Maintainer </small>  </li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p>Developed by Jens Meydam.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
