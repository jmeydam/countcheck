<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>countcheck • countcheck</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="countcheck">
<meta property="og:description" content="countcheck">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">countcheck</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/countcheck.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/jmeydam/countcheck/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="countcheck_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>countcheck</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/jmeydam/countcheck/blob/master/vignettes/countcheck.Rmd"><code>vignettes/countcheck.Rmd</code></a></small>
      <div class="hidden name"><code>countcheck.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">countcheck</span>)</pre></body></html></div>
<div id="detecting-count-anomalies-using-bayesian-hierarchical-models" class="section level2">
<h2 class="hasAnchor">
<a href="#detecting-count-anomalies-using-bayesian-hierarchical-models" class="anchor"></a>Detecting Count Anomalies Using Bayesian Hierarchical Models</h2>
<p>Prototype (R package).</p>
<ul>
<li>Dertermines upper control limits for count data</li>
<li>Reasonable results also in cases with few or no observed events</li>
<li>HTML reports</li>
</ul>
<p>Model and code are based on examples in <a href="https://xcelab.net/rm/statistical-rethinking/">McElreath (2020)</a> and <a href="https://www.stat.columbia.edu/~gelman/book/">Gelman et al. (2014)</a>.</p>
<p>This prototype is related to a previous <a href="https://jmeydam.github.io/count-anomalies/simulation_study.html">simulation study</a>.</p>
<p>The distributions and parameters in the simulation study were chosen so that the generated data is comparable to certain data of interest. The prototype is meant to be used for roughly the same kind of data. Please refer to the <a href="https://jmeydam.github.io/count-anomalies/simulation_study.html">report</a> for details.</p>
<p>The package documentation can be accessed via the <a href="https://jmeydam.github.io/countcheck/">package website</a>.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>First install dependencies:</p>
<ul>
<li>actuar</li>
<li>extraDistr</li>
<li>rstan (<a href="https://github.com/stan-dev/rstan/wiki/RStan-Getting-Started">instructions</a>)</li>
<li>rethinking (&gt;= 2.01)</li>
</ul>
<p>The rethinking package needs to be installed from <a href="https://github.com/rmcelreath/rethinking">GitHub</a>.</p>
<p>The prototype can then be installed from GitHub with:</p>
<pre><code><a href="https://devtools.r-lib.org//reference/remote-reexports.html">devtools::install_github("https://github.com/jmeydam/countcheck.git", 
                         build_vignettes = FALSE)</a></code></pre>
</div>
<div id="example-1" class="section level2">
<h2 class="hasAnchor">
<a href="#example-1" class="anchor"></a>Example 1</h2>
<p>Count data for 1000 observational units are simulated, assuming a “normal” data-generating process.</p>
<p>Since the data-generating process is free of anomalies, all counts exceeding their respective upper control limits (UCLs) are false positives. Other things being equal it is desirable to have as few false positives as possible.</p>
<p>Using a Bayesian hierarchical model with partial pooling, 18 new counts exceed their respective upper control limits, vs. 68 when using a no-pooling model. (4 counts exceed the UCLs based on the true value of the parameter <em>theta</em>, which is known in this case.)</p>
<div class="sourceCode" id="cb3"><html><body><pre class="r"><span class="no">d</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/countcheck.html">countcheck</a></span>(<span class="kw">random_seed</span> <span class="kw">=</span> <span class="fl">200807</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 1).</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Gradient evaluation took 0.000175 seconds</span>
<span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 1.75 seconds.</span>
<span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1:  Elapsed Time: 11.8155 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 1:                8.20459 seconds (Sampling)</span>
<span class="co">#&gt; Chain 1:                20.0201 seconds (Total)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 2).</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Gradient evaluation took 0.000111 seconds</span>
<span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 1.11 seconds.</span>
<span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2:  Elapsed Time: 12.0801 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 2:                16.1339 seconds (Sampling)</span>
<span class="co">#&gt; Chain 2:                28.2141 seconds (Total)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 3).</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Gradient evaluation took 0.000108 seconds</span>
<span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 1.08 seconds.</span>
<span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3:  Elapsed Time: 11.6851 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 3:                8.20417 seconds (Sampling)</span>
<span class="co">#&gt; Chain 3:                19.8893 seconds (Total)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 4).</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Gradient evaluation took 0.000111 seconds</span>
<span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 1.11 seconds.</span>
<span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4:  Elapsed Time: 11.4823 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 4:                8.28296 seconds (Sampling)</span>
<span class="co">#&gt; Chain 4:                19.7653 seconds (Total)</span>
<span class="co">#&gt; Chain 4:</span>
<span class="co">#&gt; 1000 vector or matrix parameters hidden. Use depth=2 to show them.</span>
<span class="co">#&gt;             mean          sd       5.5%      94.5%    n_eff  Rhat4</span>
<span class="co">#&gt; alpha 0.04911885 0.001317154 0.04705517 0.05122606 8231.436 1.0001</span></pre></body></html></div>
<p>Result:</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r">
<span class="co"># Counts exceeding UCLs</span>
<span class="co"># *********************</span>
<span class="co"># ucl_true_theta:</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">d</span>$<span class="no">y_new</span> - <span class="no">d</span>$<span class="no">ucl_true_theta</span> <span class="kw">&gt;</span> <span class="fl">0</span>)
<span class="co">#&gt; [1] 4</span>
<span class="co"># ucl_nopool:</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">d</span>$<span class="no">y_new</span> - <span class="no">d</span>$<span class="no">ucl_nopool</span> <span class="kw">&gt;</span> <span class="fl">0</span>)
<span class="co">#&gt; [1] 68</span>
<span class="co"># ucl_complpool:</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">d</span>$<span class="no">y_new</span> - <span class="no">d</span>$<span class="no">ucl_complpool</span> <span class="kw">&gt;</span> <span class="fl">0</span>)
<span class="co">#&gt; [1] 74</span>
<span class="co"># ucl_partpool:</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">d</span>$<span class="no">y_new</span> - <span class="no">d</span>$<span class="no">ucl_partpool</span> <span class="kw">&gt;</span> <span class="fl">0</span>)
<span class="co">#&gt; [1] 18</span>

<span class="no">d</span>[<span class="no">d</span>$<span class="no">y_new</span> - <span class="no">d</span>$<span class="no">ucl_partpool</span> <span class="kw">&gt;</span> <span class="fl">0</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"n"</span>, <span class="st">"y"</span>, <span class="st">"n_new"</span>, <span class="st">"y_new"</span>,
    <span class="st">"true_theta"</span>, <span class="st">"theta_partpool"</span>,
    <span class="st">"ucl_true_theta"</span>, <span class="st">"ucl_partpool"</span>)]
<span class="co">#&gt;        n  y n_new y_new true_theta theta_partpool ucl_true_theta ucl_partpool</span>
<span class="co">#&gt; 109   24  0    12     3 0.05812885    0.024064468            3.5          2.5</span>
<span class="co">#&gt; 228   54  1    27     4 0.11591158    0.028294979            8.5          3.5</span>
<span class="co">#&gt; 364   95  5    48     8 0.10194831    0.050662061           12.5          7.5</span>
<span class="co">#&gt; 374  100  2    50     6 0.07644745    0.026322423           10.5          5.5</span>
<span class="co">#&gt; 399  110  1    55     5 0.01644587    0.016758025            4.5          4.5</span>
<span class="co">#&gt; 462  136  2    68     8 0.04883827    0.020448365            9.5          5.5</span>
<span class="co">#&gt; 501  157  9    79    12 0.08478296    0.055070260           14.5         11.5</span>
<span class="co">#&gt; 529  171  5    86     9 0.05595134    0.032107721           11.5          8.5</span>
<span class="co">#&gt; 598  210  1   105     5 0.03900614    0.009357919           10.5          4.5</span>
<span class="co">#&gt; 613  219  2   110     6 0.01705977    0.013253719            6.5          5.5</span>
<span class="co">#&gt; 635  239 12   120    14 0.06846729    0.049781645           17.5         13.5</span>
<span class="co">#&gt; 698  289  9   145    16 0.04752106    0.033010537           15.5         11.5</span>
<span class="co">#&gt; 751  336  3   168     7 0.01771915    0.011654992            8.5          6.5</span>
<span class="co">#&gt; 805  410 39   205    33 0.15066465    0.089235197           48.5         31.5</span>
<span class="co">#&gt; 894  612 26   306    25 0.05070100    0.042802879           27.5         24.5</span>
<span class="co">#&gt; 935  802 54   401    51 0.09019851    0.066301597           54.5         42.5</span>
<span class="co">#&gt; 967 1040 26   520    25 0.03408030    0.025742256           30.5         24.5</span>
<span class="co">#&gt; 974 1124 73   562    55 0.07536090    0.064331540           62.5         54.5</span></pre></body></html></div>
<div id="alternatively" class="section level3">
<h3 class="hasAnchor">
<a href="#alternatively" class="anchor"></a>Alternatively:</h3>
<p>Using the dataset provided in the package, the same result (here without the true_theta values) can be obtained with:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">e</span> <span class="kw">&lt;-</span> <span class="no">simdat</span>
<span class="no">d1</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/countcheck.html">countcheck</a></span>(<span class="kw">unit</span> <span class="kw">=</span> <span class="no">e</span>$<span class="no">unit</span>,
                 <span class="kw">n</span> <span class="kw">=</span> <span class="no">e</span>$<span class="no">n</span>,
                 <span class="kw">y</span> <span class="kw">=</span> <span class="no">e</span>$<span class="no">y</span>,
                 <span class="kw">n_new</span> <span class="kw">=</span> <span class="no">e</span>$<span class="no">n_new</span>,
                 <span class="kw">y_new</span> <span class="kw">=</span> <span class="no">e</span>$<span class="no">y_new</span>,
                 <span class="kw">random_seed</span> <span class="kw">=</span> <span class="fl">200807</span>)
<span class="co">#&gt; recompiling to avoid crashing R session</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 1).</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Gradient evaluation took 0.000218 seconds</span>
<span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 2.18 seconds.</span>
<span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1:  Elapsed Time: 12.1959 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 1:                8.25442 seconds (Sampling)</span>
<span class="co">#&gt; Chain 1:                20.4503 seconds (Total)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 2).</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Gradient evaluation took 0.000106 seconds</span>
<span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 1.06 seconds.</span>
<span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2:  Elapsed Time: 11.975 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 2:                16.2118 seconds (Sampling)</span>
<span class="co">#&gt; Chain 2:                28.1868 seconds (Total)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 3).</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Gradient evaluation took 0.000105 seconds</span>
<span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 1.05 seconds.</span>
<span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3:  Elapsed Time: 11.7481 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 3:                8.25281 seconds (Sampling)</span>
<span class="co">#&gt; Chain 3:                20.0009 seconds (Total)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 4).</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Gradient evaluation took 0.000104 seconds</span>
<span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 1.04 seconds.</span>
<span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4:  Elapsed Time: 11.5715 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 4:                8.22317 seconds (Sampling)</span>
<span class="co">#&gt; Chain 4:                19.7946 seconds (Total)</span>
<span class="co">#&gt; Chain 4:</span>
<span class="co">#&gt; 1000 vector or matrix parameters hidden. Use depth=2 to show them.</span>
<span class="co">#&gt;             mean          sd       5.5%      94.5%    n_eff  Rhat4</span>
<span class="co">#&gt; alpha 0.04911885 0.001317154 0.04705517 0.05122606 8231.436 1.0001</span></pre></body></html></div>
<p>Result:</p>
<div class="sourceCode" id="cb6"><html><body><pre class="r"><span class="no">d1</span>[<span class="no">d1</span>$<span class="no">y_new</span> - <span class="no">d1</span>$<span class="no">ucl_partpool</span> <span class="kw">&gt;</span> <span class="fl">0</span>,
   <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"n"</span>, <span class="st">"y"</span>, <span class="st">"n_new"</span>, <span class="st">"y_new"</span>,
     <span class="st">"true_theta"</span>, <span class="st">"theta_partpool"</span>,
     <span class="st">"ucl_true_theta"</span>, <span class="st">"ucl_partpool"</span>)]
<span class="co">#&gt;        n  y n_new y_new true_theta theta_partpool ucl_true_theta ucl_partpool</span>
<span class="co">#&gt; 109   24  0    12     3         NA    0.024064468             NA          2.5</span>
<span class="co">#&gt; 228   54  1    27     4         NA    0.028294979             NA          3.5</span>
<span class="co">#&gt; 364   95  5    48     8         NA    0.050662061             NA          7.5</span>
<span class="co">#&gt; 374  100  2    50     6         NA    0.026322423             NA          5.5</span>
<span class="co">#&gt; 399  110  1    55     5         NA    0.016758025             NA          4.5</span>
<span class="co">#&gt; 462  136  2    68     8         NA    0.020448365             NA          5.5</span>
<span class="co">#&gt; 501  157  9    79    12         NA    0.055070260             NA         11.5</span>
<span class="co">#&gt; 529  171  5    86     9         NA    0.032107721             NA          8.5</span>
<span class="co">#&gt; 598  210  1   105     5         NA    0.009357919             NA          4.5</span>
<span class="co">#&gt; 613  219  2   110     6         NA    0.013253719             NA          5.5</span>
<span class="co">#&gt; 635  239 12   120    14         NA    0.049781645             NA         13.5</span>
<span class="co">#&gt; 698  289  9   145    16         NA    0.033010537             NA         11.5</span>
<span class="co">#&gt; 751  336  3   168     7         NA    0.011654992             NA          6.5</span>
<span class="co">#&gt; 805  410 39   205    33         NA    0.089235197             NA         31.5</span>
<span class="co">#&gt; 894  612 26   306    25         NA    0.042802879             NA         24.5</span>
<span class="co">#&gt; 935  802 54   401    51         NA    0.066301597             NA         42.5</span>
<span class="co">#&gt; 967 1040 26   520    25         NA    0.025742256             NA         24.5</span>
<span class="co">#&gt; 974 1124 73   562    55         NA    0.064331540             NA         54.5</span></pre></body></html></div>
</div>
</div>
<div id="example-2" class="section level2">
<h2 class="hasAnchor">
<a href="#example-2" class="anchor"></a>Example 2</h2>
<p>The count data in the first example were simulated with a known, “normal” data-generating process. Some new count values of interest <em>y_new</em> were 0.</p>
<p>In this example we change <em>y_new</em> as follows:</p>
<p><code>y_new = round(2 * ceiling(e$n_new * e$true_theta))</code></p>
<p>This is essentially twice the expected value for <em>y_new</em>, given a new reference count value n_new (used as a measure of exposure) and a value for <em>theta</em>. We round the result up, and the lowest possible value in this example is 1.</p>
<p>Since we use a factor of 2, it is likely that the product will often exceed the upper control limit (UCL).</p>
<p>Using a Bayesian hierarchical model with partial pooling, 332 new counts exceed their respective upper control limits, vs. 489 when using a no-pooling model. 310 counts exceed the UCLs based on the true value of the parameter <em>theta</em>, which is known in this case.</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">d2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/countcheck.html">countcheck</a></span>(<span class="kw">unit</span> <span class="kw">=</span> <span class="no">e</span>$<span class="no">unit</span>,
                 <span class="kw">n</span> <span class="kw">=</span> <span class="no">e</span>$<span class="no">n</span>,
                 <span class="kw">y</span> <span class="kw">=</span> <span class="no">e</span>$<span class="no">y</span>,
                 <span class="kw">n_new</span> <span class="kw">=</span> <span class="no">e</span>$<span class="no">n_new</span>,
                 <span class="kw">y_new</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span>(<span class="fl">2</span> * <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span>(<span class="no">e</span>$<span class="no">n_new</span> * <span class="no">e</span>$<span class="no">true_theta</span>)),
                 <span class="kw">true_theta</span> <span class="kw">=</span> <span class="no">e</span>$<span class="no">true_theta</span>,
                 <span class="kw">random_seed</span> <span class="kw">=</span> <span class="fl">200807</span>)
<span class="co">#&gt; recompiling to avoid crashing R session</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 1).</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Gradient evaluation took 0.000201 seconds</span>
<span class="co">#&gt; Chain 1: 1000 transitions using 10 leapfrog steps per transition would take 2.01 seconds.</span>
<span class="co">#&gt; Chain 1: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 1: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; Chain 1:  Elapsed Time: 12.6327 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 1:                8.77642 seconds (Sampling)</span>
<span class="co">#&gt; Chain 1:                21.4092 seconds (Total)</span>
<span class="co">#&gt; Chain 1: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 2).</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Gradient evaluation took 0.00011 seconds</span>
<span class="co">#&gt; Chain 2: 1000 transitions using 10 leapfrog steps per transition would take 1.1 seconds.</span>
<span class="co">#&gt; Chain 2: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 2: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; Chain 2:  Elapsed Time: 13.8637 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 2:                18.8886 seconds (Sampling)</span>
<span class="co">#&gt; Chain 2:                32.7523 seconds (Total)</span>
<span class="co">#&gt; Chain 2: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 3).</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Gradient evaluation took 0.000136 seconds</span>
<span class="co">#&gt; Chain 3: 1000 transitions using 10 leapfrog steps per transition would take 1.36 seconds.</span>
<span class="co">#&gt; Chain 3: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 3: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; Chain 3:  Elapsed Time: 14.6325 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 3:                8.34875 seconds (Sampling)</span>
<span class="co">#&gt; Chain 3:                22.9812 seconds (Total)</span>
<span class="co">#&gt; Chain 3: </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; SAMPLING FOR MODEL '70f8c7029a69cad74d26c394cfc0955b' NOW (CHAIN 4).</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Gradient evaluation took 0.000104 seconds</span>
<span class="co">#&gt; Chain 4: 1000 transitions using 10 leapfrog steps per transition would take 1.04 seconds.</span>
<span class="co">#&gt; Chain 4: Adjust your expectations accordingly!</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4: Iteration:    1 / 4000 [  0%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration:  400 / 4000 [ 10%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration:  800 / 4000 [ 20%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1200 / 4000 [ 30%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 1600 / 4000 [ 40%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 2000 / 4000 [ 50%]  (Warmup)</span>
<span class="co">#&gt; Chain 4: Iteration: 2001 / 4000 [ 50%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 2400 / 4000 [ 60%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 2800 / 4000 [ 70%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 3200 / 4000 [ 80%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 3600 / 4000 [ 90%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: Iteration: 4000 / 4000 [100%]  (Sampling)</span>
<span class="co">#&gt; Chain 4: </span>
<span class="co">#&gt; Chain 4:  Elapsed Time: 11.8322 seconds (Warm-up)</span>
<span class="co">#&gt; Chain 4:                8.64359 seconds (Sampling)</span>
<span class="co">#&gt; Chain 4:                20.4758 seconds (Total)</span>
<span class="co">#&gt; Chain 4:</span>
<span class="co">#&gt; 1000 vector or matrix parameters hidden. Use depth=2 to show them.</span>
<span class="co">#&gt;             mean          sd       5.5%      94.5%    n_eff  Rhat4</span>
<span class="co">#&gt; alpha 0.04911885 0.001317154 0.04705517 0.05122606 8231.436 1.0001</span></pre></body></html></div>
<p>Result:</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="co"># Counts exceeding UCLs</span>
<span class="co"># *********************</span>
<span class="co"># ucl_true_theta:</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">d2</span>$<span class="no">y_new</span> - <span class="no">d2</span>$<span class="no">ucl_true_theta</span> <span class="kw">&gt;</span> <span class="fl">0</span>)
<span class="co">#&gt; [1] 310</span>
<span class="co"># ucl_nopool:</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">d2</span>$<span class="no">y_new</span> - <span class="no">d2</span>$<span class="no">ucl_nopool</span> <span class="kw">&gt;</span> <span class="fl">0</span>)
<span class="co">#&gt; [1] 489</span>
<span class="co"># ucl_complpool:</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">d2</span>$<span class="no">y_new</span> - <span class="no">d2</span>$<span class="no">ucl_complpool</span> <span class="kw">&gt;</span> <span class="fl">0</span>)
<span class="co">#&gt; [1] 343</span>
<span class="co"># ucl_partpool:</span>
<span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span>(<span class="no">d2</span>$<span class="no">y_new</span> - <span class="no">d2</span>$<span class="no">ucl_partpool</span> <span class="kw">&gt;</span> <span class="fl">0</span>)
<span class="co">#&gt; [1] 332</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(
  <span class="no">d2</span>[<span class="no">d2</span>$<span class="no">y_new</span> - <span class="no">d2</span>$<span class="no">ucl_partpool</span> <span class="kw">&gt;</span> <span class="fl">0</span>,
     <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"n"</span>, <span class="st">"y"</span>, <span class="st">"n_new"</span>, <span class="st">"y_new"</span>,
       <span class="st">"true_theta"</span>, <span class="st">"theta_partpool"</span>,
       <span class="st">"ucl_true_theta"</span>, <span class="st">"ucl_partpool"</span>)]
)
<span class="co">#&gt;   n y n_new y_new  true_theta theta_partpool ucl_true_theta ucl_partpool</span>
<span class="co">#&gt; 1 1 0     1     2 0.049278162     0.03815631            1.5          1.5</span>
<span class="co">#&gt; 2 1 0     1     2 0.050456677     0.03806424            1.5          1.5</span>
<span class="co">#&gt; 3 1 0     1     2 0.118428974     0.03879413            1.5          1.5</span>
<span class="co">#&gt; 4 2 0     1     2 0.072886179     0.03742913            1.5          1.5</span>
<span class="co">#&gt; 5 2 0     1     2 0.004318677     0.03759384            0.5          1.5</span>
<span class="co">#&gt; 6 2 0     1     2 0.014761557     0.03784933            0.5          1.5</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span>(
  <span class="no">d2</span>[<span class="no">d2</span>$<span class="no">y_new</span> - <span class="no">d2</span>$<span class="no">ucl_partpool</span> <span class="kw">&gt;</span> <span class="fl">0</span>,
     <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"n"</span>, <span class="st">"y"</span>, <span class="st">"n_new"</span>, <span class="st">"y_new"</span>,
       <span class="st">"true_theta"</span>, <span class="st">"theta_partpool"</span>,
       <span class="st">"ucl_true_theta"</span>, <span class="st">"ucl_partpool"</span>)]
)
<span class="co">#&gt;         n   y n_new y_new  true_theta theta_partpool ucl_true_theta</span>
<span class="co">#&gt; 995  1952 150   976   176 0.089378272    0.076146467          115.5</span>
<span class="co">#&gt; 996  2202   4  1101    10 0.003693479    0.002268037           10.5</span>
<span class="co">#&gt; 997  2334  60  1167    70 0.029640283    0.025967249           52.5</span>
<span class="co">#&gt; 998  2505  41  1253    38 0.014551266    0.016720363           31.5</span>
<span class="co">#&gt; 999  3780 238  1890   250 0.065819145    0.062777478          158.5</span>
<span class="co">#&gt; 1000 3909  63  1955    76 0.019160583    0.016331095           56.5</span>
<span class="co">#&gt;      ucl_partpool</span>
<span class="co">#&gt; 995         100.5</span>
<span class="co">#&gt; 996           7.5</span>
<span class="co">#&gt; 997          47.5</span>
<span class="co">#&gt; 998          35.5</span>
<span class="co">#&gt; 999         151.5</span>
<span class="co">#&gt; 1000         49.5</span></pre></body></html></div>
<p>As analyzed in detail in the <a href="https://jmeydam.github.io/count-anomalies/simulation_study.html">simulation study</a>, if we gradually increase the factor from 1 to 8 we will find that the number of cases exceeding the UCL is similar for the partial-pooling and true-theta UCLs, but initially substantially higher for the no-pooling UCLs, as was demonstrated here for a factor of 2. The no-pooling UCL performs poorly especially when the previously observed count <em>y</em> was 0, leading to an UCL of 0.5.</p>
<p>The general results are not affected when changing the seed value.</p>
<p>In a realistic scenario it is not possible to assess performance by comparison with “true” values. The true values of <em>theta</em> are generally not known, and the probability distributions assumed for the Bayesian hierarchical model (the no-pooling model) may in fact be inappropriate.</p>
<p>On the other hand, in a realistic scenario it is often possible to assess performance by investigating individual cases.</p>
</div>
<div id="html-report" class="section level2">
<h2 class="hasAnchor">
<a href="#html-report" class="anchor"></a>HTML Report</h2>
<p>Select data from data frame d (example 1 above) for the report:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="no">countcheck_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/select_for_report.html">select_for_report</a></span>(<span class="no">d</span>)</pre></body></html></div>
<p>Result:</p>
<div class="sourceCode" id="cb10"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">countcheck_df</span>)
<span class="co">#&gt; 'data.frame':    18 obs. of  3 variables:</span>
<span class="co">#&gt;  $ y_new       : int  8 16 51 3 4 5 5 6 6 7 ...</span>
<span class="co">#&gt;  $ ucl_partpool: num  5.5 11.5 42.5 2.5 3.5 4.5 4.5 5.5 5.5 6.5 ...</span>
<span class="co">#&gt;  $ unit        : int  462 698 935 109 228 399 598 374 613 751 ...</span></pre></body></html></div>
<p>We also need a data frame with unit master data. Here, we just simulate data:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">units_tmp</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span>(<span class="no">countcheck_df</span>$<span class="no">unit</span>))
<span class="no">unit_df</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span>(
  <span class="kw">unit</span> <span class="kw">=</span> <span class="no">units_tmp</span>,
  <span class="kw">unit_name</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Unit"</span>,
                    <span class="no">units_tmp</span>),
  <span class="kw">unit_url</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="st">"http://domain/units/"</span>,
                    <span class="no">units_tmp</span>,
                    <span class="st">".html"</span>),
  <span class="kw">unit_group_name</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"Group"</span>,
                          <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span>(<span class="fl">1</span>:<span class="fl">5</span>,
                              <span class="kw">length.out</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span>(<span class="no">units_tmp</span>)))
)</pre></body></html></div>
<p>Result:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/str.html">str</a></span>(<span class="no">unit_df</span>)
<span class="co">#&gt; 'data.frame':    18 obs. of  4 variables:</span>
<span class="co">#&gt;  $ unit           : int  109 228 364 374 399 462 501 529 598 613 ...</span>
<span class="co">#&gt;  $ unit_name      : chr  "Unit 109" "Unit 228" "Unit 364" "Unit 374" ...</span>
<span class="co">#&gt;  $ unit_url       : chr  "http://domain/units/109.html" "http://domain/units/228.html" "http://domain/units/364.html" "http://domain/units/374.html" ...</span>
<span class="co">#&gt;  $ unit_group_name: chr  "Group 1" "Group 2" "Group 3" "Group 4" ...</span></pre></body></html></div>
<p>Generate report as R string:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">report</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/html_report.html">html_report</a></span>(
  <span class="kw">countcheck_list</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
    <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">df</span> <span class="kw">=</span> <span class="no">countcheck_df</span>, <span class="kw">caption</span> <span class="kw">=</span> <span class="st">"KPI 1"</span>)
  ),
  <span class="kw">unit_df</span> <span class="kw">=</span> <span class="no">unit_df</span>,
  <span class="kw">title</span> <span class="kw">=</span> <span class="st">"Report"</span>,
  <span class="kw">table_width_px</span> <span class="kw">=</span> <span class="fl">500</span>,
  <span class="kw">column_headers</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(
    <span class="kw">group</span> <span class="kw">=</span> <span class="st">"Group"</span>,
    <span class="kw">count</span> <span class="kw">=</span> <span class="st">"Count"</span>,
    <span class="kw">ucl</span> <span class="kw">=</span> <span class="st">"UCL"</span>,
    <span class="kw">unit</span> <span class="kw">=</span> <span class="st">"Unit"</span>,
    <span class="kw">name</span> <span class="kw">=</span> <span class="st">"Name"</span>),
  <span class="kw">charset</span> <span class="kw">=</span> <span class="st">"utf-8"</span>,
  <span class="kw">lang</span> <span class="kw">=</span> <span class="st">"en"</span>,
  <span class="kw">home_url</span> <span class="kw">=</span> <span class="st">"https://github.com/jmeydam/countcheck"</span>)</pre></body></html></div>
<p>Save HTML report to disk:</p>
<pre><code>&gt; sink("report.html")
&gt; cat(report)
&gt; sink()</code></pre>
<p><a href="https://jmeydam.github.io/countcheck/report.html">View HTML report</a></p>
<p><br><br></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Jens Meydam.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
