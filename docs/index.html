<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Detecting Count Anomalies Using Bayesian Hierarchical Models • countcheck</title>
<script src="deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="deps/headroom-0.11.0/headroom.min.js"></script><script src="deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="deps/search-1.0.0/fuse.min.js"></script><script src="deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="pkgdown.js"></script><meta property="og:title" content="Detecting Count Anomalies Using Bayesian Hierarchical Models">
<meta name="description" content="Dertermines upper control limits for count data. Reasonable results also in cases with few or no observed events. HTML reports. Model and code are based on examples in McElreath [2020] and Gelman et al. [2014].">
<meta property="og:description" content="Dertermines upper control limits for count data. Reasonable results also in cases with few or no observed events. HTML reports. Model and code are based on examples in McElreath [2020] and Gelman et al. [2014].">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="index.html">countcheck</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.2.0</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="articles/countcheck.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="reference/index.html">Reference</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/jmeydam/countcheck/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-home">
<div class="row">
  <main id="main" class="col-md-9"><div class="section level1">
<div class="page-header"><h1 id="countcheck">countcheck<a class="anchor" aria-label="anchor" href="#countcheck"></a>
</h1></div>
<div class="section level2">
<h2 id="detecting-count-anomalies-using-bayesian-hierarchical-models">Detecting Count Anomalies Using Bayesian Hierarchical Models<a class="anchor" aria-label="anchor" href="#detecting-count-anomalies-using-bayesian-hierarchical-models"></a>
</h2>
<p>Prototype (R package).</p>
<ul>
<li>Dertermines upper control limits for count data</li>
<li>Reasonable results also in cases with few or no observed events</li>
<li>HTML reports</li>
</ul>
<p>Model and code are based on examples in <a href="https://www.stat.columbia.edu/~gelman/book/" class="external-link">Gelman et al. (2014)</a> and <a href="https://xcelab.net/rm/statistical-rethinking/" class="external-link">McElreath (2020)</a>.</p>
<p>This prototype is related to a previous <a href="https://jmeydam.github.io/count-anomalies/simulation_study.html" class="external-link">simulation study</a>.</p>
<p>The distributions and parameters in the simulation study were chosen so that the generated data is comparable to certain data of interest. The prototype is meant to be used for roughly the same kind of data. Please refer to this <a href="https://jmeydam.github.io/count-anomalies/simulation_study.html" class="external-link">report</a> for details.</p>
<p>The package documentation can be accessed via the <a href="https://jmeydam.github.io/countcheck/" class="external-link">package website</a>.</p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>Install the following R packages and their dependencies:</p>
<ul>
<li>actuar</li>
<li>extraDistr</li>
<li>cmdstanr (<a href="https://mc-stan.org/cmdstanr/articles/cmdstanr.html" class="external-link">instructions</a>, also for installing CmdStan)</li>
</ul>
<p>The prototype can then be installed from GitHub with:</p>
<pre><code><span><span class="fu">devtools</span><span class="fu">::</span><span class="fu"><a href="https://remotes.r-lib.org/reference/install_github.html" class="external-link">install_github</a></span><span class="op">(</span><span class="st">"https://github.com/jmeydam/countcheck.git"</span>,</span>
<span>                         build_vignettes <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>We simulate count data for 1000 observational units, assuming a certain known data-generating process.</p>
<p>The data-generating process is free of anomalies, and all counts exceeding their respective upper control limits (UCLs) are false positives. Other things being equal it is desirable to have as few false positives as possible.</p>
<p>Using a Bayesian hierarchical model with partial pooling, 18 new counts exceed their respective upper control limits, vs. 68 when using a no-pooling model. (4 counts exceed the UCLs based on the true value of the parameter <em>theta</em>, which is known in this case.)</p>
<pre><code>&gt; library(countcheck)

&gt; d &lt;- countcheck(random_seed = 200807)

&gt; # Counts exceeding UCLs
&gt; # *********************
&gt; # ucl_true_theta:
&gt; sum(d$y_new - d$ucl_true_theta &gt; 0)
[1] 4
&gt; # ucl_nopool:
&gt; sum(d$y_new - d$ucl_nopool &gt; 0)
[1] 68
&gt; # ucl_complpool:
&gt; sum(d$y_new - d$ucl_complpool &gt; 0)
[1] 74
&gt; # ucl_partpool:
&gt; sum(d$y_new - d$ucl_partpool &gt; 0)
[1] 18</code></pre>
<div class="section level3">
<h3 id="alternatively">Alternatively:<a class="anchor" aria-label="anchor" href="#alternatively"></a>
</h3>
<p>Using the dataset provided in the package, the same result (here without the true_theta values) can be obtained with:</p>
<pre><code>&gt; e &lt;- simdat
&gt; d1 &lt;- countcheck(unit = e$unit,
+                  n = e$n,
+                  y = e$y,
+                  n_new = e$n_new,
+                  y_new = e$y_new,
+                  random_seed = 200807)</code></pre>
<p>In a realistic scenario it is not possible to assess performance by comparison with “true” values. The true values of <em>theta</em> are generally not known, and the probability distributions assumed for the Bayesian hierarchical model (the no-pooling model) may in fact be inappropriate.</p>
<p>On the other hand, in a realistic scenario it is often possible to assess performance by investigating individual cases.</p>
</div>
</div>
<div class="section level2">
<h2 id="html-report">HTML Report<a class="anchor" aria-label="anchor" href="#html-report"></a>
</h2>
<p>Select data from data frame d (example above) for the report:</p>
<pre><code>&gt; countcheck_df &lt;- select_for_report(d)</code></pre>
<p>We also need a data frame with unit master data. Here, we just generate some data:</p>
<pre><code>&gt; units_tmp &lt;- sort(unique(countcheck_df$unit))
&gt; unit_df &lt;- data.frame(
+   unit = units_tmp,
+   unit_name = paste("Unit",
+                     units_tmp),
+   unit_url = paste0("http://domain/units/",
+                     units_tmp,
+                     ".html"),
+   unit_group_name = paste("Group",
+                           rep(1:5,
+                               length.out = length(units_tmp)))
+ )</code></pre>
<p>Generate report as R string:</p>
<pre><code>&gt; report &lt;- html_report(
+   countcheck_list = list(
+     list(df = countcheck_df, caption = "KPI 1")
+   ),
+   unit_df = unit_df,
+   title = "Report",
+   table_width_px = 500,
+   column_headers = c(
+     group = "Group",
+     count = "Count",
+     ucl = "UCL",
+     unit = "Unit",
+     name = "Name"),
+   charset = "utf-8",
+   lang = "en",
+   home_url = "https://github.com/jmeydam/countcheck"
+ )</code></pre>
<p>Save HTML report to disk:</p>
<pre><code>&gt; sink("report.html")
&gt; cat(report)
&gt; sink()</code></pre>
<p><a href="https://jmeydam.github.io/countcheck/report.html" class="external-link">View HTML report</a></p>
<p><br></p>
</div>
</div>
  </main><aside class="col-md-3"><div class="links">
<h2 data-toc-skip>Links</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/jmeydam/countcheck/" class="external-link">Browse source code</a></li>
<li><a href="https://github.com/jmeydam/countcheck/issues" class="external-link">Report a bug</a></li>
</ul>
</div>

<div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a></li>
</ul>
</div>


<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing countcheck</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Jens Meydam <br><small class="roles"> Maintainer </small>  </li>
</ul>
</div>



  </aside>
</div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Jens Meydam.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
